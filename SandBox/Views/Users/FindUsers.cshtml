@{
    ViewBag.Title = "FindUsers";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Subscriptions</h2>
<br />

<div id="subscriptions" class="d-flex align-content-start flex-wrap">

</div>


@section scripts
{
    <script src="~/Scripts/jsrender.min.js" type="text/javascript"></script>

    <script type="text/x-jsrender" id="subscriber-template">
        <div class="w-50 m-0 p-0">
            <div class="m-2 p-2 d-flex js-subscriber-container" style="border: solid 1px black;" data-user-id="{{:id}}">
                <label class="my-auto">
                    <strong>{{:nickname}}</strong>
                </label>
                <button class="btn btn-danger ml-auto js-toggle-subscription" data-subscription-state="subscribed">
                    Unsubscribe
                </button>
            </div>
        </div>
    </script>

    <script>
        $(document).ready(function () {
            $.ajax({
                type: "GET",
                url: "/api/subscriptions/" + "@ViewBag.Id",
                dataType: "json",
                success: function (data) {
                    var subscriptionTemplate = $.templates("#subscriber-template");

                    $("#subscriptions").html(subscriptionTemplate.render(data));

                },
            });

            $("#subscriptions").on("click", ".js-toggle-subscription", function () {
                var button = $(this);                

                toggleSubscription(button);
            });


            function toggleSubscription(button) {
                var userId = button.parents(".js-subscriber-container").attr("data-user-id");

                if (button.attr("data-subscription-state") === "subscribed") {
                    $.ajax({
                        type: "DELETE",
                        url: "/api/subscriptions/" + userId,
                        dataType: "json",
                        success: function (data) {
                            button.removeClass("btn-danger").addClass("btn-primary").html("Subscribe back").attr("data-subscription-state", "unsubscribed");

                            toastr.options = {
                                progressBar: true,
                                positionClass: "toast-bottom-full-width",
                                timeOut: 3000,
                            };
                            toastr.info(data);
                        }
                    });
                }
                else {
                    $.ajax({
                        type: "POST",
                        url: "/api/subscriptions/" + userId,
                        dataType: "json",
                        success: function (data) {
                            button.removeClass("btn-primary").addClass("btn-danger").html("Unsubscribe").attr("data-subscription-state", "subscribed");

                            toastr.options = {
                                progressBar: true,
                                positionClass: "toast-bottom-full-width",
                                timeOut: 3000,
                            };
                            toastr.success(data);
                        }
                    });
                }
            }
        });
    </script>
}